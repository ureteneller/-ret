<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Bildirimler ‚Ä¢ √úreten Eller</title>
  <link rel="icon" href="/assets/icons/favicon.png" />
  <style>
    :root{ --bg1:#0b1220; --bg2:#0a0f1c; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --brd:#1f2937; --card:#0e172a; --card2:#0b1326; --safe-inset: env(safe-area-inset-bottom, 0px); }
    *{box-sizing:border-box}
    html,body{
  margin:0;
  padding:0;
  background:#ffffff;
  color:#111827;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
  max-width:100%;
  overflow-x:hidden
}

    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:1rem 1rem calc(6.25rem + var(--safe-inset))}
    .top{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:.5rem;font-weight:900}
    .logo img{width:32px;height:32px}
    .spacer{flex:1}

    .btn,
button{
  display:inline-flex;
  align-items:center;
  gap:.4rem;
  padding:.6rem 1rem;

  background:linear-gradient(
    135deg,
    #fff1a8 0%,
    #ffd700 25%,
    #ffec8b 50%,
    #d4af37 75%,
    #fff1a8 100%
  );

  color:#000000;
  font-weight:800;

  border:1px solid rgba(212,175,55,.6);
  border-radius:14px;

  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);

  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.7),
    0 8px 22px rgba(212,175,55,.45);

  cursor:pointer;
  transition:all .2s ease;
}

.btn:hover,
button:hover{
  transform:translateY(-1px);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.9),
    0 14px 30px rgba(212,175,55,.6);
}

.btn:active,
button:active{
  transform:translateY(0);
  box-shadow:
    inset 0 4px 10px rgba(0,0,0,.2);
}

.btn[disabled],
button[disabled]{
  opacity:.6;
  cursor:not-allowed;
}

    .head{display:flex;align-items:center;justify-content:space-between;margin:1rem 0 .6rem;gap:.75rem}
    .mini{color:var(--muted)}

    .filters{display:flex;gap:.5rem;flex-wrap:wrap}
    .chip{
  padding:.45rem .9rem;
  border-radius:999px;

  background:linear-gradient(
    135deg,
    #fff1a8 0%,
    #ffd700 30%,
    #ffec8b 55%,
    #d4af37 80%,
    #fff1a8 100%
  );

  color:#3b2f00;
  font-weight:900;

  border:1px solid rgba(212,175,55,.6);

  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);

  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.75),
    0 6px 18px rgba(212,175,55,.35);

  cursor:pointer;
  transition:all .2s ease;
}

.chip:hover{
  transform:translateY(-1px);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.9),
    0 10px 26px rgba(212,175,55,.5);
}

.chip[aria-selected="true"]{
  background:linear-gradient(
    135deg,
    #ffef9c,
    #ffdd55,
    #ffd700,
    #f1c232
  );

  border-color:rgba(212,175,55,.9);

  box-shadow:
    inset 0 2px 6px rgba(255,255,255,.8),
    0 0 0 2px rgba(212,175,55,.35),
    0 10px 30px rgba(212,175,55,.55);
}


    .list{display:grid;gap:.6rem}
    .item{display:grid;grid-template-columns:24px 1fr auto;gap:.6rem;align-items:flex-start;border:1px solid var(--brd);border-radius:16px;background:linear-gradient(145deg,var(--card),var(--card2));padding:.7rem}
    .item.unread{box-shadow:0 0 0 1px #22d3ee55, 0 0 16px #22d3ee22}
    .it-title{font-weight:900}
    .it-meta{display:flex;gap:.5rem;flex-wrap:wrap}
    .it-actions{display:flex;gap:.4rem}
    .notice{border:1px dashed var(--brd);border-radius:14px;padding:.7rem .8rem;background:#0c1426}
    .toast{position:fixed;left:50%;bottom:calc(82px + var(--safe-inset));transform:translateX(-50%);background:#0b1220;border:1px solid var(--brd);padding:.5rem .75rem;border-radius:10px;font-weight:800;z-index:1200;display:none}

    .bottomBar{
  position:fixed;
  left:0; right:0; bottom:0;

  background:linear-gradient(
    135deg,
    rgba(255,241,168,.85),
    rgba(255,215,0,.85),
    rgba(212,175,55,.85)
  );

  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);

  border-top:1px solid rgba(212,175,55,.6);

  display:flex;
  justify-content:space-around;
  gap:.5rem;

  padding:.55rem calc(6px + var(--safe-inset)) .6rem;

  color:#000000;
  z-index:100;

  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.7),
    0 -8px 30px rgba(212,175,55,.45);
}

.bbtn{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:.25rem;

  font-weight:900;
  padding:.45rem .2rem;

  border-radius:14px;
  border:1px solid transparent;

  background:rgba(255,255,255,.25);

  color:#000000;
  cursor:pointer;

  transition:all .2s ease;
}

.bbtn:hover{
  background:rgba(255,255,255,.45);
}

.bbtn[aria-current="page"]{
  background:rgba(255,255,255,.6);
  border-color:rgba(212,175,55,.8);

  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.8),
    0 4px 14px rgba(212,175,55,.5);
}

    .bicon{width:22px;height:22px;display:block}
  </style>

  <!-- Firestore i√ßin global yardƒ±mcƒ±larƒ± saƒülayan dosya (TEK KEZ) -->
<script type="module" src="/firebase-init.js"></script>

<!-- Gƒ∞Rƒ∞≈û KORUMASI -->
<script type="module">
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js';

  (function protectPage(){
    try{
      const auth = getAuth(self.__fb?.app);
      onAuthStateChanged(auth, async (user) => {
        if (!user) { location.replace('/index.html'); return; }
        const usesPassword = user.providerData?.some(p => p.providerId === 'password');
        try { await user.reload(); } catch(_) {}
        if (usesPassword && !user.emailVerified) { location.replace('/index.html'); return; }
      });
    }catch(e){
      console.warn('protectPage hata', e);
      try{ location.replace('/index.html'); }catch(_){}
    }
  })();
</script>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">
        <img src="/assets/icons/ureteneller.png" alt="logo" />
        <span>√úreten Eller</span>
      </div>
      <div class="spacer"></div>
      <button class="btn ghost" id="btnBack" type="button">‚Üê Profile D√∂n</button>
    </div>

    <section class="head" aria-labelledby="nTitle">
      <div>
        <h2 id="nTitle">Bildirimler</h2>
        <div class="mini" id="nSub">‚Äî</div>
      </div>
      <div class="filters" role="tablist" aria-label="Bildirim filtreleri">
        <button class="chip" role="tab" data-filter="all" aria-selected="true">T√ºm√º</button>
        <button class="chip" role="tab" data-filter="unread" aria-selected="false">Okunmamƒ±≈ü</button>
        <button class="chip" role="tab" data-filter="read" aria-selected="false">Okunan</button>
      </div>
    </section>

    <div class="head">
      <div class="mini" id="summaryLine">Toplam: 0 ‚Ä¢ Okunmamƒ±≈ü: 0</div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn" id="btnMarkAllRead" type="button">T√ºm√ºn√º okundu i≈üaretle</button>
        <button class="btn danger" id="btnDeleteSelected" type="button" disabled>Se√ßiliyi sil</button>
        <button class="btn warn" id="btnDeleteAll" type="button">T√ºm√ºn√º sil</button>
      </div>
    </div>

    <main class="list" id="listHost" aria-live="polite"></main>
    <div id="emptyBox" class="notice mini" style="display:none">Kayƒ±t yok.</div>
  </div>

  <nav class="bottomBar" aria-label="Alt gezinme">
    <button class="bbtn" id="navHome" type="button">
      <svg class="bicon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 3l9 8h-3v8h-5v-5H11v5H6v-8H3l9-8z"/></svg>
      <span class="mini">Ana Sayfa</span>
    </button>
    <button class="bbtn" id="navMsg" type="button">
      <svg class="bicon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M4 4h16v12H8l-4 4V4z"/></svg>
      <span class="mini">Mesajlar</span>
    </button>
    <button class="bbtn" id="navNotif" type="button" aria-current="page">
      <svg class="bicon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 22a2 2 0 0 0 2-2H10a2 2 0 0 0 2 2zm6-6V11a6 6 0 0 0-5-5.91V4a1 1 0 0 0-2 0v1.09A6 6 0 0 0 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
      <span class="mini">Bildirimler</span>
    </button>
  </nav>

  <div id="toast" class="toast" role="status"></div>
  <!-- UYARI SESƒ∞ -->
  <audio id="notifSound" src="./notify.wav" preload="auto"></audio>

  <script>
    const $ = (s)=>document.querySelector(s);
    const toast=(m)=>{ const t=$('#toast'); t.textContent=m; t.style.display='block'; clearTimeout(window.__t); window.__t=setTimeout(()=>t.style.display='none',1600); };
    const fmtDate=(ts)=>{ try{ if(!ts) return '‚Äî'; const d=ts.toDate? ts.toDate() : new Date(ts); return d.toLocaleString('tr-TR'); }catch{ return '‚Äî'; } };

    let __uid=null, __unsub=null, __filter='all', __selected=new Set();
    const sound = $('#notifSound');
    let __prevUnread = Number(localStorage.getItem('ue_notif_unread_count')||'0')||0;
    
    // ==== ADMIN Bƒ∞LDƒ∞Rƒ∞ G√ñNDER (yalnƒ±zca isAdmin:true kullanƒ±cƒ± g√∂r√ºr) ====
async function __checkIsAdmin(uid){
  try{
    const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
    const snap = await getDoc(doc(window.__fb.db, 'users', uid));
    const d = snap.exists() ? (snap.data()||{}) : {};
    return !!d.isAdmin;
  }catch(_){ return false; }
}

function __injectAdminBox(){
  const top = document.querySelector('.top');
  if(!top || document.getElementById('adminBox')) return;

  const box = document.createElement('div');
  box.id = 'adminBox';
  box.className = 'notice';
  box.style.marginTop = '.75rem';
  box.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;gap:.5rem;flex-wrap:wrap;margin-bottom:.5rem">
      <strong>üîí Admin: Bildiri G√∂nder</strong>
      <small class="mini">notifications ‚Üí userId hedefli</small>
    </div>
    <form id="adminForm" style="display:grid;gap:.5rem;grid-template-columns:1fr 1fr;align-items:end">
      <label style="display:flex;flex-direction:column;gap:.35rem">
        <span class="mini">Kime (userId)</span>
        <input id="nf_user" placeholder="Hedef kullanƒ±cƒ± UID" style="padding:.55rem;border-radius:10px;border:1px solid var(--brd);background:#0b1220;color:#fff">
      </label>
      <label style="display:flex;flex-direction:column;gap:.35rem">
        <span class="mini">Ba≈ülƒ±k</span>
        <input id="nf_title" placeholder="Ba≈ülƒ±k" style="padding:.55rem;border-radius:10px;border:1px solid var(--brd);background:#0b1220;color:#fff">
      </label>
      <label style="grid-column:1/-1;display:flex;flex-direction:column;gap:.35rem">
        <span class="mini">Mesaj</span>
        <textarea id="nf_text" rows="2" placeholder="Mesaj i√ßeriƒüi" style="padding:.55rem;border-radius:10px;border:1px solid var(--brd);background:#0b1220;color:#fff"></textarea>
      </label>
      <label style="display:flex;flex-direction:column;gap:.35rem">
        <span class="mini">Baƒülantƒ± (opsiyonel)</span>
        <input id="nf_link" placeholder="https://..." style="padding:.55rem;border-radius:10px;border:1px solid var(--brd);background:#0b1220;color:#fff">
      </label>
      <label style="display:flex;flex-direction:column;gap:.35rem">
        <span class="mini">Sipari≈ü ID (opsiyonel)</span>
        <input id="nf_oid" placeholder="orderId" style="padding:.55rem;border-radius:10px;border:1px solid var(--brd);background:#0b1220;color:#fff">
      </label>
      <div style="grid-column:1/-1;display:flex;gap:.5rem;justify-content:flex-end">
        <button type="submit" class="btn primary">G√∂nder</button>
      </div>
    </form>
  `;
  top.after(box);

  document.getElementById('adminForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const userId = (document.getElementById('nf_user').value||'').trim();
    const title  = (document.getElementById('nf_title').value||'').trim();
    const text   = (document.getElementById('nf_text').value||'').trim();
    const link   = (document.getElementById('nf_link').value||'').trim();
    const orderId= (document.getElementById('nf_oid').value||'').trim();

    if(!userId || !title || !text){ toast('userId, ba≈ülƒ±k ve mesaj zorunlu'); return; }

    try{
      const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      await addDoc(collection(window.__fb.db, 'notifications'), {
        userId, title, text, link: link||'', orderId: orderId||null,
        read:false, createdAt: serverTimestamp()
      });
      toast('G√∂nderildi');
      // formu temizle
      document.getElementById('nf_title').value='';
      document.getElementById('nf_text').value='';
      document.getElementById('nf_link').value='';
      document.getElementById('nf_oid').value='';
    }catch(e){
      console.warn('notif add error', e);
      toast('Hata: g√∂nderilemedi');
    }
  });
}

// Auth sonrasƒ± admin mi bak ‚Üí panel g√∂ster
(async function __maybeShowAdmin(){
  // Firebase hazƒ±r olduƒüunda √ßalƒ±≈üacak
  (function wait(){ 
    if(!window.__fb || !window.__fb.auth){ return setTimeout(wait,50); }
    window.__fb.onAuthStateChanged(window.__fb.auth, async (u)=>{
      if(!u) return;
      if(await __checkIsAdmin(u.uid)) __injectAdminBox();
    });
  })();
})();

    // --------- UI ---------
    function renderList(items){
      const host = $('#listHost');
      host.innerHTML='';
      const filtered = items.filter(it=>{
        if(__filter==='unread') return !it.read;
        if(__filter==='read') return !!it.read;
        return true;
      });
      if(filtered.length===0){ $('#emptyBox').style.display='block'; } else { $('#emptyBox').style.display='none'; }

      filtered.forEach(it=>{
        const row=document.createElement('div');
        row.className='item'+(it.read?'':' unread');
        row.innerHTML=`
          <input type="checkbox" aria-label="Se√ß" data-id="${it.id}" ${__selected.has(it.id)?'checked':''} />
          <div>
            <div class="it-title">${it.title||'(Ba≈ülƒ±ksƒ±z)'}</div>
            <div class="mini" style="margin:.2rem 0 .35rem">${it.text||''}</div>
            <div class="it-meta mini">
              <span>${fmtDate(it.createdAt)}</span>
              ${it.link? `<a class="mini" href="${safeLink(it.link)}">Baƒülantƒ±yƒ± a√ß</a>`:''}
              ${it.orderId? `<a class="mini" href="./order.html?id=${encodeURIComponent(it.orderId)}">Sipari≈ü</a>`:''}
            </div>
          </div>
          <div class="it-actions">
            <button class="btn" data-act="toggle" data-id="${it.id}" title="${it.read?'Okunmadƒ± yap':'Okundu yap'}">${it.read?'‚Ä¢ Oku':'‚úì Okundu'}</button>
            <button class="btn danger" data-act="del" data-id="${it.id}">Sil</button>
          </div>
        `;
        // events
        row.querySelectorAll('button,[type="checkbox"]').forEach(el=>{
          el.addEventListener('click', (ev)=>{
            const id=el.getAttribute('data-id');
            const act=el.getAttribute('data-act');
            if(el.type==='checkbox'){ if(el.checked) __selected.add(id); else __selected.delete(id); updateBulkButtons(); return; }
            if(act==='toggle') toggleRead(id);
            if(act==='del') removeOne(id);
          });
        });
        host.appendChild(row);
      });
    }

    function updateHeaderCounts(total, unread){
      $('#summaryLine').textContent = `Toplam: ${total} ‚Ä¢ Okunmamƒ±≈ü: ${unread}`;
      // Yeni unread varsa ses
      if(unread>__prevUnread){
        try{ sound.currentTime=0; sound.play().catch(()=>{}); }catch{}
      }
      __prevUnread=unread;
      localStorage.setItem('ue_notif_unread_count', String(unread));
    }

    function bindFilters(){
      document.querySelectorAll('.chip').forEach(ch=>{
        ch.addEventListener('click', ()=>{
          document.querySelectorAll('.chip').forEach(x=>x.setAttribute('aria-selected','false'));
          ch.setAttribute('aria-selected','true');
          __filter=ch.dataset.filter||'all';
          // yeniden boyayacaƒüƒ±z; veriler snapshot i√ßinde tutuluyor
          if(window.__lastItems) renderList(window.__lastItems);
        });
      });
    }

    function updateBulkButtons(){
      $('#btnDeleteSelected').disabled = __selected.size===0;
    }

    // --------- Firebase Ops ---------
    async function toggleRead(id){
      try{
        const {doc,updateDoc,serverTimestamp} = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        await updateDoc(doc(window.__fb.db,'notifications',id),{ read: true, readAt: serverTimestamp() },{merge:true});
        toast('‚úì');
      }catch(e){ console.warn(e); toast('Hata'); }
    }

    async function markAllRead(uid){
      try{
        const {collection,query,where,getDocs,doc,updateDoc,serverTimestamp} = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        const q=query(collection(window.__fb.db,'notifications'), where('userId','==',uid), where('read','==',false));
        const snap=await getDocs(q);
        const jobs=[];
        snap.forEach(ds=> jobs.push(updateDoc(doc(window.__fb.db,'notifications',ds.id),{read:true,readAt:serverTimestamp()})));
        await Promise.all(jobs);
        toast('Hepsi okundu');
      }catch(e){ console.warn(e); toast('Hata'); }
    }

    async function removeOne(id){
      try{
        const {doc,deleteDoc} = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        await deleteDoc(doc(window.__fb.db,'notifications',id));
        __selected.delete(id);
        toast('Silindi');
      }catch(e){ console.warn(e); toast('Hata'); }
    }

    async function removeSelected(){
      try{
        const {doc,deleteDoc} = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        const jobs=[...__selected].map(id=>deleteDoc(doc(window.__fb.db,'notifications',id)));
        await Promise.all(jobs);
        __selected.clear();
        updateBulkButtons();
        toast('Se√ßili silindi');
      }catch(e){ console.warn(e); toast('Hata'); }
    }

    async function removeAll(uid){
      try{
        const {collection,query,where,getDocs,doc,deleteDoc} = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        const q=query(collection(window.__fb.db,'notifications'), where('userId','==',uid));
        const snap=await getDocs(q);
        const jobs=[];
        snap.forEach(ds=> jobs.push(deleteDoc(doc(window.__fb.db,'notifications',ds.id))));
        await Promise.all(jobs);
        __selected.clear();
        updateBulkButtons();
        toast('Hepsi silindi');
      }catch(e){ console.warn(e); toast('Hata'); }
    }

    async function watchNotifs(uid){
      const {collection,query,where,orderBy,onSnapshot} = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const q=query(collection(window.__fb.db,'notifications'), where('userId','==',uid), orderBy('createdAt','desc'));
      if(__unsub){ try{__unsub();}catch{} }
      __unsub = onSnapshot(q,(snap)=>{
        const items=[]; let unread=0;
        snap.forEach(ds=>{
          const d=ds.data()||{};
          const it={ id:ds.id, title:d.title||'', text:d.text||'', read:!!d.read, createdAt:d.createdAt||null, link:d.link||'', orderId:d.orderId||null };
          items.push(it); if(!it.read) unread++;
        });
        window.__lastItems = items;
        renderList(items);
        $('#nSub').textContent = items.length ? 'Yeni gelen bildirimler burada.' : '‚Äî';
        updateHeaderCounts(items.length, unread);
      },(err)=>{ console.warn('notif snapshot',err); });
    }

    function safeLink(u){
      try{
        const url=new URL(u, location.origin);
        return url.href;
      }catch{ return '#'; }
    }

    // --------- Boot ---------
    function boot(){
      $('#btnBack').onclick=()=>{ history.length>1 ? history.back() : location.href='./profile.html'; };
      bindFilters();
      $('#btnMarkAllRead').onclick=()=>{ if(__uid) markAllRead(__uid); };
      $('#btnDeleteSelected').onclick=removeSelected;
      $('#btnDeleteAll').onclick=()=>{ if(__uid && confirm('T√ºm bildirimleri silmek istiyor musunuz?')) removeAll(__uid); };
      // bottom bar
      document.getElementById('navHome').onclick=(e)=>{ e.preventDefault(); location.href='/home.html'; };
      document.getElementById('navMsg').onclick=(e)=>{ e.preventDefault(); location.href='./mesajlar.html'; };
      document.getElementById('navNotif').onclick=(e)=>{ e.preventDefault(); /* zaten buradayƒ±z */ };
    }

    (function init(){
      if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', boot); } else { boot(); }
      // Firebase hazƒ±r olunca auth
      (function waitForFirebase(){
        if(!window.__fb){ setTimeout(waitForFirebase,50); return; }
        const {auth,onAuthStateChanged}=window.__fb;
        onAuthStateChanged(auth,(u)=>{
          if(!u){ location.href='./index.html'; return; }
          __uid=u.uid;
          watchNotifs(__uid);
        });
      })();
    })();
  </script>
</body>
</html>
